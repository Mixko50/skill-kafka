stages:
  - test
  - build
  - deploy

test-skill-api:
  stage: test
  image: golang:latest
  script:
    - cd api
    - go install
    - make test

test-skill-consumer:
  stage: test
  image: golang:latest
  script:
    - cd consumer
    - go install
    - make test

build-skill-api:
  stage: build
  needs:
    - job: test-skill-api
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t $SKILL_API_REGISTRIES:$SKILL_API_VERSION -f  ./api/Dockerfile ./api
    - docker tag $SKILL_API_REGISTRIES:$SKILL_API_VERSION $SKILL_API_REGISTRIES:latest

build-skill-consumer:
  stage: build
  needs:
    - job: test-skill-consumer
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t $SKILL_CONSUMER_REGISTRIES:$SKILL_CONSUMER_VERSION -f  ./consumer/Dockerfile ./consumer
    - docker tag $SKILL_CONSUMER_REGISTRIES:$SKILL_CONSUMER_VERSION $SKILL_CONSUMER_REGISTRIES:latest